---

const { buttonId = "auth-btn", pwdVariable, urlVariable } = Astro.props;

---

<style>
  .inline-button {
    display: inline-block;
    vertical-align: middle;
  }
</style>

<!-- Secured Link Button -->
  <button 
      id={buttonId}
      class="inline-button items-center"
      title="secured link"
      aria-label="securedlink"
  >
      <slot/>
  </button>

<!-- Secure Password Modal -->
<div id="password-modal" class="fixed flex inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
        <h3 class="text-lg font-semibold mb-4 mt-0 dark:text-white">Enter Password</h3>
        <input 
            type="password" 
            id="password-input" 
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg mb-4 dark:bg-gray-700 dark:text-white"
            placeholder="Password"
        />
        <div id="error-message" class="text-red-500 text-sm mb-2 hidden"></div>
        <div id="status-message" class="text-green-500 text-sm mb-2 hidden"></div>
        <div class="flex gap-2">
            <button 
                id="submit-password" 
                class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-all duration-200 disabled:opacity-50"
            >
                Submit
            </button>
            <button 
                id="cancel-password" 
                class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-white px-4 py-2 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition-all duration-200"
            >
                Cancel
            </button>
        </div>
    </div>
</div>

<script define:vars={{ buttonId, pwdVariable, urlVariable }}>
    class SecureAuthHandler {
        modal;
        passwordInput;
        submitBtn;
        cancelBtn;
        errorMessage;
        statusMessage;
        isLoading;
        authBtn;
        boundEvents;

        constructor() {
            this.modal = null;
            this.passwordInput = null;
            this.submitBtn = null;
            this.cancelBtn = null;
            this.errorMessage = null;
            this.statusMessage = null;
            this.authBtn = null;
            this.isLoading = false;
            this.boundEvents = false;
            
            // Event handler references for proper cleanup
            this.authClickHandler = null;
            this.cancelClickHandler = null;
            this.submitClickHandler = null;
            this.openLinkClickHandler = null;
            this.modalClickHandler = null;
            this.passwordKeyHandler = null;
        }

        init() {
            // Always re-query DOM elements to handle page navigation
            this.authBtn = document.getElementById(buttonId);
            this.modal = document.getElementById('password-modal');
            this.passwordInput = document.getElementById('password-input');
            this.submitBtn = document.getElementById('submit-password');
            this.cancelBtn = document.getElementById('cancel-password');
            this.errorMessage = document.getElementById('error-message');
            this.statusMessage = document.getElementById('status-message');

            // Remove existing event listeners to prevent duplicates
            this.cleanup();
            
            // Bind new event listeners
            this.bindEvents();
            this.boundEvents = true;
            return true;
        }

        cleanup() {
            if (this.boundEvents) {
                // Store references to the bound functions so we can remove them
                if (this.authBtn && this.authClickHandler) {
                    this.authBtn.removeEventListener('click', this.authClickHandler);
                }
                if (this.cancelBtn && this.cancelClickHandler) {
                    this.cancelBtn.removeEventListener('click', this.cancelClickHandler);
                }
                if (this.submitBtn && this.submitClickHandler) {
                    this.submitBtn.removeEventListener('click', this.submitClickHandler);
                }
                if (this.submitBtn && this.openLinkClickHandler) {
                    this.submitBtn.removeEventListener('click', this.openLinkClickHandler);
                }
                if (this.modal && this.modalClickHandler) {
                    this.modal.removeEventListener('click', this.modalClickHandler);
                }
                if (this.passwordInput && this.passwordKeyHandler) {
                    this.passwordInput.removeEventListener('keypress', this.passwordKeyHandler);
                }
                this.hideStatus();
                this.statusMessage.textContent = '';
                this.hideError();
                this.errorMessage.textContent = '';
            }
            this.boundEvents = false;
        }

        bindEvents() {
            // Store bound functions as class properties so we can remove them later
            this.authClickHandler = () => this.showModal();
            this.cancelClickHandler = () => this.hideModal();
            this.submitClickHandler = () => this.handleSubmit();
            this.modalClickHandler = (e) => {
                if (e.target === this.modal) {
                    this.hideModal();
                }
            };
            this.passwordKeyHandler = (e) => {
                if (e.key === 'Enter' && !this.isLoading) {
                    this.handleSubmit();
                }
            };

            // Add event listeners
            this.authBtn.addEventListener('click', this.authClickHandler);
            this.cancelBtn.addEventListener('click', this.cancelClickHandler);
            this.submitBtn.addEventListener('click', this.submitClickHandler);
            this.modal.addEventListener('click', this.modalClickHandler);
            this.passwordInput.addEventListener('keypress', this.passwordKeyHandler);
        }

        openLink(url) {
            window.open(url, '_blank');
        }

        showModal() {
            this.modal.classList.remove('hidden');
            this.modal.classList.add('flex');
            this.passwordInput.focus();
            this.passwordInput.value = '';
            this.hideError();
        }

        hideModal() {
            this.modal.classList.add('hidden');
            this.modal.classList.remove('flex');
            this.passwordInput.value = '';
            this.hideError();
            this.setLoading(false);
        }

        showError(message) {
            this.errorMessage.textContent = message;
            this.errorMessage.classList.remove('hidden');
        }

        hideError() {
            this.errorMessage.classList.add('hidden');
        }

        showStatus(message) {
            this.statusMessage.innerHTML = message;
            this.statusMessage.classList.remove('hidden');
        }

        hideStatus() {
            this.statusMessage.classList.add('hidden');
        }

        setLoading(loading) {
            this.isLoading = loading;
            this.submitBtn.disabled = loading;
            this.submitBtn.textContent = loading ? 'Verifying...' : 'Submit';
        }

        async handleSubmit() {
            if (this.isLoading) return;

            const password = this.passwordInput.value.trim();
            if (!password) {
                this.showError('Please enter a password');
                return;
            }

            this.setLoading(true);
            this.hideError();

            try {
                const response = await fetch('/.netlify/functions/authenticate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ pwdVariable, urlVariable, password })
                });

                const data = await response.json();

                if (data.success && data.url) {
                    this.submitBtn.textContent = 'Verified';
                    window.open(data.url, '_blank');
                    this.showStatus('Access granted! Redirecting...');

                    setTimeout(() => {
                        this.submitBtn.textContent = 'Open Link';
                        this.submitBtn.removeEventListener('click', this.submitClickHandler);
                        this.openLinkClickHandler = () => this.openLink(data.url);
                        this.submitBtn.addEventListener('click', this.openLinkClickHandler);
                    }, 4000);
                } else {
                    this.showError(data.error);
                    this.passwordInput.value = '';
                    this.passwordInput.focus();
                }
            } catch (error) {
                this.showError('Network error. Please try again.');
            } finally {
                this.setLoading(false);
            }
        }
    }

    // Use a Map to store handlers per button ID to support multiple instances
    const handlerMap = new Map();

    function initSecureAuth() {
        // Clean up previous handler for this button ID
        const existingHandler = handlerMap.get(buttonId);
        if (existingHandler) {
            existingHandler.cleanup();
        }

        // Create new handler
        const handler = new SecureAuthHandler();
        let success = handler.init();
        
        // If initialization failed, try again after a short delay
        if (!success) {
            setTimeout(() => {
                success = handler.init();
                if (success) {
                    handlerMap.set(buttonId, handler);
                }
            }, 100);
        } else {
            handlerMap.set(buttonId, handler);
        }
    }

    // Clean up on page unload
    function cleanup() {
        const handler = handlerMap.get(buttonId);
        if (handler) {
            handler.cleanup();
            handlerMap.delete(buttonId);
        }
    }

    // Initialize on various events to ensure it works with Astro navigation
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSecureAuth);
    } else {
        initSecureAuth();
    }

    // Astro-specific page load event
    document.addEventListener('astro:page-load', initSecureAuth);
    
    // Backup for traditional page loads
    window.addEventListener('load', initSecureAuth);
    
    // Clean up when leaving the page
    document.addEventListener('astro:before-preparation', cleanup);
    window.addEventListener('beforeunload', cleanup);
</script>
